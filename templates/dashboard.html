{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  <h1>ğŸ“Š Dashboard</h1>
  <h2>Attendance Percentage: {{ data.overall.percentage }}%</h2>
  <h3>Current Streak: {{ data.streak }} days</h3>
  
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-primary">{{ data.overall.present }}</h4>
          <p class="card-text">Classes Attended</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-danger">{{ data.overall.absent }}</h4>
          <p class="card-text">Classes Missed</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-success">{{ data.streak }}</h4>
          <p class="card-text">Day Streak</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-info">{{ data.overall.safe_bunk_periods }}</h4>
          <p class="card-text">Safe Bunks</p>
        </div>
      </div>
    </div>
  </div>
  
  <h3>ğŸ“… Attendance Calendar</h3>
  <div id="cal-heatmap" style="min-height: 140px;"></div>
  
  <!-- Calendar CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/cal-heatmap@4.2.4/dist/cal-heatmap.css" />
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/cal-heatmap@4.2.4/dist/cal-heatmap.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarData = {{ calendar_data | tojson }};
      console.log('Calendar data:', calendarData);
      
      // Wait for libraries to load
      setTimeout(function() {
        if (typeof CalHeatmap === 'undefined') {
          console.error('CalHeatmap library failed to load');
          document.getElementById('cal-heatmap').innerHTML = '<div class="alert alert-warning">Calendar library failed to load. Showing simple attendance grid instead.</div>';
          showSimpleCalendar(calendarData);
          return;
        }
        
        if (calendarData && calendarData.length > 0) {
          try {
            // Determine dynamic start and range
            const dates = calendarData.map(d => new Date(d.date));
            const minDate = new Date(Math.min.apply(null, dates));
            const today = new Date();
            // Always include months up to today
            const maxDate = today;
            const start = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            const end = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
            const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
            
            // Build full date map for the whole semester (fill holidays)
            const oneDay = 24 * 60 * 60 * 1000;
            const fullMap = {};
            const endOfMaxMonth = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);
            for (let t = start.getTime(); t <= endOfMaxMonth.getTime(); t += oneDay) {
              const d = new Date(t);
              const key = d.toISOString().slice(0,10);
              fullMap[key] = 0; // default holiday
            }
            calendarData.forEach(item => {
              const key = new Date(item.date).toISOString().slice(0,10);
              fullMap[key] = item.value; // 1 present, -1 absent, 0 holiday
            });

            // Flatten to array for JSON source
            const source = Object.keys(fullMap).map(k => ({ date: k, value: fullMap[k] }));

            const cal = new CalHeatmap();
            cal.paint({
              itemSelector: '#cal-heatmap',
              date: { start: start },
              domain: { type: 'month', gutter: 10, label: { position: 'top' } },
              subDomain: {
                type: 'day', width: 18, height: 18, radius: 3,
                label: (timestamp) => new Date(timestamp).getDate().toString()
              },
              data: { source: source, type: 'json', x: 'date', y: 'value' },
              range: Math.max(months, 1),
              scale: {
                color: {
                  type: 'ordinal',
                  domain: [-1, 0, 1],
                  range: ['#e74c3c', '#ffffff', '#2ecc71']
                }
              },
              onClick: (date, value) => {
                console.log('Clicked:', new Date(date), 'value:', value);
              }
            });
          } catch (error) {
            console.error('Calendar rendering error:', error);
            document.getElementById('cal-heatmap').innerHTML = '<div class="alert alert-warning">Calendar could not be rendered. Error: ' + error.message + '</div>';
            showSimpleCalendar(calendarData);
          }
        } else {
          document.getElementById('cal-heatmap').innerHTML = '<div class="alert alert-info">No calendar data available yet. This might be due to date parsing issues. Check the console for details.</div>';
        }
      }, 1000);
      
      // Fallback simple calendar function
      function showSimpleCalendar(data) {
        if (!data || data.length === 0) return;
        
        let html = '<div class="simple-calendar mt-3"><h5>Attendance Overview</h5><div class="row">';
        
        data.forEach((item, index) => {
          const date = new Date(item.date);
          const dateStr = date.toLocaleDateString('en-GB');
          const status = item.value === 1 ? 'Present' : 'Absent';
          const badgeClass = item.value === 1 ? 'bg-success' : 'bg-danger';
          
          if (index % 7 === 0 && index > 0) html += '</div><div class="row">';
          
          html += `<div class="col">
            <div class="card mb-2" style="min-height: 60px;">
              <div class="card-body p-2 text-center">
                <small class="d-block">${dateStr}</small>
                <span class="badge ${badgeClass}">${status}</span>
              </div>
            </div>
          </div>`;
        });
        
        html += '</div></div>';
        document.getElementById('cal-heatmap').innerHTML = html;
      }
    });
  </script>
  
  <h3 class="mt-4">ğŸ“š Subject-wise Attendance</h3>
  {{ table_html | safe }}
  
  <div class="mt-4">
    <a href="/b_safe" class="btn btn-primary">B-Safe</a>
    <a href="/lab" class="btn btn-primary">Lab</a>
    <a href="/profile" class="btn btn-secondary">Profile</a>
  </div>
  
  {% if data.overall.percentage < 75 %}
    {% set required = (3 * data.overall.absent - data.overall.present) %}
    <div class="alert alert-warning mt-4">
      âš ï¸ Warning: Your attendance is below 75%!
      {% if required > 0 %}
        ğŸ“… You need to attend at least {{ required }} more classes consecutively to reach 75% attendance.
      {% else %}
        ğŸ‰ You are already eligible. Just maintain your attendance!
      {% endif %}
    </div>
  {% endif %}
  
  {% if data.overall.percentage >= 90 %}
  <div class="alert alert-success mt-4">
    ğŸ‰ <strong>Excellent Attendance!</strong> You're doing great with {{ data.overall.percentage }}% attendance.
  </div>
  {% elif data.overall.percentage >= 85 %}
  <div class="alert alert-info mt-4">
    ğŸ‘ <strong>Good Attendance!</strong> Keep maintaining your {{ data.overall.percentage }}% attendance rate.
  </div>
  {% endif %}
{% endblock %}